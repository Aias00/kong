build-packages:
# As a general rule, binaries built on one Linux distro will only
# work on other Linux distros that are the same age or newer.
# Therefore, if we want to make binaries that run on most Linux distros,
# we have to use an old enough distro.

# label: used to distinguish artifacts for later use; make sure its value ends with -arm64 if
#         it's a cross-compiled for ARM64 target
# os: docker image if not ubuntu/debian, otherwise ignored
# package: package type
# bazel_args: additional bazel build flags
# check-manifest-file: the manifest file path relative to scripts/explain_manifest to check

# Ubuntu
- label: ubuntu-18.04
  os: ubuntu-22.04
  image: ubuntu:18.04
  package: deb
  check-manifest-file: ubuntu-18.04-amd64.txt
- label: ubuntu-20.04
  os: ubuntu-20.04
  package: deb
  check-manifest-file: ubuntu-20.04-amd64.txt
- label: ubuntu-22.04
  os: ubuntu-22.04
  package: deb
  check-manifest-file: ubuntu-22.04-amd64.txt
- label: ubuntu-22.04-arm64
  os: ubuntu-22.04
  package: deb
  bazel_args: --platforms=//:ubuntu-22.04-arm64
  check-manifest-file: ubuntu-22.04-arm64.txt
- label: ubuntu-20.04-fips
  os: ubuntu-20.04
  package: deb
  bazel_args: --//:fips=true
  check-manifest-file: ubuntu-20.04-amd64-fips.txt
- label: ubuntu-22.04-fips
  os: ubuntu-22.04
  package: deb
  bazel_args: --//:fips=true
  check-manifest-file: ubuntu-22.04-amd64-fips.txt

# Debian
- label: debian-10
  os: ubuntu-18.04
  package: deb
  check-manifest-file: ubuntu-18.04-amd64.txt
- label: debian-11
  os: ubuntu-20.04
  package: deb
  check-manifest-file: ubuntu-20.04-amd64.txt

# CentOS
- label: centos-7
  os: ubuntu-22.04
  image: centos:7
  package: rpm
  check-manifest-file: el7-amd64.txt

# RHEL
- label: rhel-7
  os: ubuntu-22.04
  image: centos:7
  package: rpm
  check-manifest-file: el7-amd64.txt
- label: rhel-8-fips
  os: ubuntu-22.04
  image: rockylinux:8 # note we are not using ubi8 here as some packages needs subscription
  package: rpm
  bazel_args: --//:fips=true
  check-manifest-file: el8-amd64-fips.txt

# Alpine
- label: alpine
  os: ubuntu-22.04
  package: apk
  bazel_args: --platforms=//:alpine-x86_64
  check-manifest-file: alpine-amd64.txt

# Amazon Linux
- label: amazonlinux-2
  os: ubuntu-22.04
  image: amazonlinux:2
  package: rpm
  check-manifest-file: amazonlinux-2-amd64.txt
- label: amazonlinux-2-arm64
  os: ubuntu-22.04-arm64
  package: rpm
  image: amazonlinux:2
  check-manifest-file: amazonlinux-2-arm64.txt

build-images:
# Only build images for the latest version of each major release.

# label: used as compose docker image label ${github.sha}-${label}
# base-image: docker image to use as base
# package: package type
# artifact-from: label of build-packages to use
# artifact-from-alt: another label of build-packages to use for downloading package (to build multi-arch image)
# docker_platforms: comma separated list of docker buildx platforms to build for

# Ubuntu
- label: ubuntu
  base-image: ubuntu:22.04
  package: deb
  artifact-from: ubuntu-22.04
  artifact-from-alt: ubuntu-22.04-arm64
  docker_platforms: linux/amd64, linux/arm64
- label: ubuntu-fips
  base-image: ubuntu:22.04
  package: deb
  artifact-from: ubuntu-22.04-fips


# Debian
- label: debian
  base-image: debian:11-slim
  package: deb
  artifact-from: debian-11

# RHEL
- label: rhel
  base-image: registry.access.redhat.com/ubi8
  package: rpm
  artifact-from: rhel-7

# Alpine
- label: alpine
  base-image: alpine:3.16
  package: apk
  artifact-from: alpine

# Amazon Linux
- label: amazonlinux-2
  base-image: amazonlinux:2
  package: rpm
  artifact-from: amazonlinux-2
  artifact-from-alt: amazonlinux-2-arm64
  docker_platforms: linux/amd64,linux/arm64
  rpm_platform: aws2
- label: amazonlinux-2022
  base-image: amazonlinux:2022
  package: rpm
  artifact-from: amazonlinux-2
  artifact-from-alt: amazonlinux-2-arm64
  docker_platforms: linux/amd64,linux/arm64
  rpm_platform: aws2022

smoke-tests:
- label: ubuntu
- label: ubuntu-fips
- label: debian
- label: rhel
- label: alpine
- label: amazonlinux-2
- label: amazonlinux-2022

scan-vulnerabilities:
- label: ubuntu
- label: ubuntu-fips
- label: debian
- label: rhel
- label: alpine
- label: amazonlinux-2
- label: amazonlinux-2022

release-packages:
# Ubuntu
- label: ubuntu-18.04
  package: deb
  artifact-from: ubuntu-18.04
  artifact-version: 18.04
  artifact-type: ubuntu
  artifact: kong.amd64.deb
- label: ubuntu-20.04
  package: deb
  artifact-from: ubuntu-20.04
  artifact-version: 20.04
  artifact-type: ubuntu
  artifact: kong.amd64.deb
- label: ubuntu-22.04
  package: deb
  artifact-from: ubuntu-22.04
  artifact-version: 22.04
  artifact-type: ubuntu
  artifact: kong.amd64.deb
- label: ubuntu-22.04-arm64
  package: deb
  artifact-from: ubuntu-22.04-arm64
  artifact-version: 22.04
  artifact-type: ubuntu
  artifact: kong.arm64.deb
- label: ubuntu-20.04-fips
  package: deb
  artifact-from: ubuntu-20.04-fips
  artifact-version: 20.04
  artifact-type: ubuntu
  artifact: kong.amd64.deb
- label: ubuntu-22.04-fips
  package: deb
  artifact-from: ubuntu-22.04-fips
  artifact-version: 22.04
  artifact-type: ubuntu
  artifact: kong.amd64.deb

# Debian
- label: debian-10
  package: deb
  artifact-from: debian-10
  artifact-version: 10
  artifact-type: debian
  artifact: kong.amd64.deb
- label: debian-11
  package: deb
  artifact-from: debian-11
  artifact-version: 11
  artifact-type: debian
  artifact: kong.amd64.deb

# CentOS
- label: centos-7
  package: rpm
  artifact-from: centos-7
  artifact-version: 7
  artifact-type: centos
  artifact: kong.el7.amd64.rpm

# RHEL
- label: rhel-7
  package: rpm
  artifact-from: rhel-7
  artifact-version: 7
  artifact-type: rhel
  artifact: kong.el7.amd64.rpm
- label: rhel-8
  package: rpm
  artifact-from: rhel-7
  artifact-version: 8
  artifact-type: rhel
  artifact: kong.el8.amd64.rpm
- label: rhel-8-fips
  package: rpm
  artifact-from: rhel-8-fips
  artifact-version: 8
  artifact-type: rhel
  artifact: kong.el8.amd64.rpm

  # Amazon Linux
- label: amazonlinux-2
  package: rpm
  artifact-from: amazonlinux-2
  artifact-version: 2
  artifact-type: amazonlinux
  artifact: kong.aws2.amd64.rpm
- label: amazonlinux-2-arm64
  package: rpm
  artifact-from: amazonlinux-2-arm64
  artifact-version: 2
  artifact-type: amazonlinux
  artifact: kong.aws2.arm64.rpm
- label: amazonlinux-2022
  package: rpm
  artifact-from: amazonlinux-2
  artifact-version: 2022
  artifact-type: amazonlinux
  artifact: kong.aws2022.amd64.rpm
- label: amazonlinux-2022-arm64
  package: rpm
  artifact-from: amazonlinux-2-arm64
  artifact-version: 2022
  artifact-type: amazonlinux
  artifact: kong.aws2022.arm64.rpm

# Alpine
- label: alpine
  package: apk
  artifact-from: alpine
  artifact-type: alpine
  artifact: kong.amd64.apk.tar.gz

release-images:
- label: ubuntu
- label: ubuntu-fips
- label: debian
- label: rhel
- label: alpine
- label: amazonlinux-2
- label: amazonlinux-2022
