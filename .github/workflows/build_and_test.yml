name: Build & Test

on:  # yamllint disable-line rule:truthy
  pull_request:
    paths-ignore:
    # ignore markdown files (CHANGELOG.md, README.md, etc.)
    - '**/*.md'
    - '.github/workflows/release.yml'
  push:
    branches:
    - master
    - release/*
    - next/*
    - test-please/*
    paths-ignore:
    # ignore markdown files (CHANGELOG.md, README.md, etc.)
    - '**/*.md'
    # ignore PRs for the generated COPYRIGHT file
    - 'COPYRIGHT'

env:
  LIBRARY_PREFIX: /usr/local/kong
  PULP_USERNAME: admin
  # if this is a push event, or it is pull request but not from a fork, and not from dependabot (dependabot does not use forks), then this PR will have access to secrets
  HAS_ACCESS_TO_SECRETS: ${{ github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, 'dependabot')) }}
  TEST_RESULTS_XML_OUTPUT: test-results

# cancel previous runs if new commits are pushed to the PR, but run for each commit on master
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build:
    name: Build dependencies
    runs-on: [self-hosted, Hetzner]

    steps:
    - name: Set environment variables
      run: |
          echo "INSTALL_ROOT=$(pwd)/bazel-bin/build/kong-dev" >> $GITHUB_ENV

    - name: Checkout Kong source code
      uses: actions/checkout@v3
      with:
        submodules: recursive
        token: ${{ secrets.GHA_KONG_BOT_READ_TOKEN }}

    - name: Swap git with https
      run: git config --global url."https://github".insteadOf git://github

    - name: Cache Build Output
      id: cache-deps
      # Note we only use the artifact in build, which may actually contain
      # lua source codes from a previous version. But both busted and pongo
      # is able to override those files with them under current directory
      # so we don't need to rebuild it everytime. So that also means
      # the "artifacts" here can't be used as a per-commit CD artifact; only
      # the ones from release.yml could.
      uses: actions/cache@v3
      with:
        path: |
          artifacts
          ${{ env.INSTALL_ROOT }}-venv.sh
        key: ci-build-${{ hashFiles('.requirements', 'kong-*.rockspec', 'plugins-ee/**/*.rockspec', '.bazelversion', '.bazelrc', 'build/**', 'BUILD.bazel', 'WORKSPACE', '.github/workflows/build_and_test.yml') }}

    - name: Set .requirements into environment variables
      run: |
        sed -i 's/c\.release = true/c\.release = false/g' distribution/distributions_constants.lua
        grep -v '^#' .requirements >> $GITHUB_ENV

    - name: Install Build Dependencies
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install libyaml-dev valgrind libprotobuf-dev -y

    - name: Build Kong and package
      if: steps.cache-deps.outputs.cache-hit != 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GHA_KONG_BOT_READ_TOKEN }}
      run: |
        bazel build //build:kong --verbose_failures --action_env=INSTALL_DESTDIR=/usr/local
        bazel build //build:venv --verbose_failures --action_env=INSTALL_DESTDIR=/usr/local
        # debian package for Pongo
        bazel build :kong_deb --verbose_failures --action_env=INSTALL_DESTDIR=/usr/local

    - name: Bazel Outputs
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: bazel-outputs
        path: |
          bazel-out/_tmp/actions

    - name: Collect artifacts
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        mkdir artifacts
        cp bazel-bin/pkg/kong.amd64.deb artifacts/

        # bazel output directory without write access, we add it when creating archive
        tar -zcvf artifacts/build.tar.gz -C bazel-bin/build/kong-dev --mode="a+rw" .

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build
        path: |
          artifacts
          ${{ env.INSTALL_ROOT }}-venv.sh

  cp-dp-compatibility-test:
    name: CP/DP compatibility
    runs-on: [self-hosted, Hetzner]
    timeout-minutes: 30
    needs: build
    if: false # FIXME(@flrgh): re-enable with FT-3478

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: kong
          POSTGRES_DB: kong
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 5s --health-timeout 5s --health-retries 8

    steps:
    - name: Set environment variables
      run: |
          echo "INSTALL_ROOT=$(pwd)/bazel-bin/build/kong-dev" >> $GITHUB_ENV

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: build
        path: .

    - name: Extract the artifact contents
      run: sudo tar -C /usr/local/ -xzvf artifacts/build.tar.gz

    - name: Install packages
      run: sudo apt update && sudo apt install -y libyaml-dev valgrind libprotobuf-dev libpam-dev jq httpie

    - name: Checkout Kong source code
      uses: actions/checkout@v3

    - name: Install Kong dev
      run: make dev LIBRARY_PREFIX=/usr/local/kong

    - name: Generate hybrid cert
      run: |
        cd $GITHUB_WORKSPACE
        kong hybrid gen_cert

    - name: Check version compatibility
      env:
        GITHUB_TOKEN: ${{ secrets.GHA_KONG_BOT_READ_TOKEN }}
        PULP_PASSWORD: ${{ secrets.PULP_PASSWORD }}
      run: |
        KONG_LICENSE_URL="https://download.konghq.com/internal/kong-gateway/license.json"
        export KONG_LICENSE_DATA=$(curl \
          --silent \
          --location \
          --retry 3 \
          --retry-delay 3 \
          --user "$PULP_USERNAME:$PULP_PASSWORD" \
          --url "$KONG_LICENSE_URL"
        )

        if [[ -z $KONG_LICENSE_DATA ]]; then
          echo "failed downloading license from $KONG_LICENSE_URL"
          exit 1
        fi

        mkdir -p $GITHUB_WORKSPACE/servroot/dp

        docker run -d \
          --name kong-dp \
          --network host \
          --user root \
          -v "$GITHUB_WORKSPACE/servroot/dp:/usr/local/kong/servroot" \
          -v "$GITHUB_WORKSPACE/cluster.crt:/usr/local/kong/cluster.crt" \
          -v "$GITHUB_WORKSPACE/cluster.key:/usr/local/kong/cluster.key" \
          -e "KONG_LOG_LEVEL=error" \
          -e "KONG_NGINX_USER=root root" \
          -e "KONG_PREFIX=/usr/local/kong/servroot" \
          -e "KONG_LICENSE_DATA=$KONG_LICENSE_DATA" \
          -e "KONG_CLUSTER_CERT=/usr/local/kong/cluster.crt" \
          -e "KONG_CLUSTER_CERT_KEY=/usr/local/kong/cluster.key" \
          -e "KONG_DATABASE=off" \
          -e "KONG_ROLE=data_plane" \
          kong/kong-gateway:3.0 kong start

        kong migrations bootstrap

        export KONG_PREFIX=$GITHUB_WORKSPACE/servroot/cp
        export KONG_LOG_LEVEL=error
        export KONG_ROLE=control_plane
        export KONG_CLUSTER_CERT=$GITHUB_WORKSPACE/cluster.crt
        export KONG_CLUSTER_CERT_KEY=$GITHUB_WORKSPACE/cluster.key
        kong start --vv

        KONG_PATH=$GITHUB_WORKSPACE ./scripts/check-version-compatibility

        docker kill kong-dp
        kong stop

        CONFIG_ERRORS=$(cat $GITHUB_WORKSPACE/servroot/dp/logs/error.log | sed -n '/unable to update running config/,/context: ngx.timer$/p')

        unset KONG_LICENSE_DATA

        if [[ -n $CONFIG_ERRORS ]]; then
          echo -e "Version Compatibility Errors Occurred\n------------------------------\n\n"
          echo "$CONFIG_ERRORS"
          exit 1
        fi

        source ${{ env.INSTALL_ROOT }}-venv.sh
        make dev LIBRARY_PREFIX=/usr/local/kong

  sca-doc-and-unit-tests:
    name: Static Code Analysis, Doc and Unit tests
    runs-on: [self-hosted, Hetzner]
    needs: build

    env:
      KONG_TEST_PG_DATABASE: kong
      KONG_TEST_PG_USER: kong

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: kong
          POSTGRES_DB: kong
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 5s --health-timeout 5s --health-retries 8

    steps:
    - name: Set environment variables
      run: |
          echo "INSTALL_ROOT=$(pwd)/bazel-bin/build/kong-dev" >> $GITHUB_ENV

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: build
        path: .

    - name: Extract the artifact contents
      run: sudo tar -C /usr/local/ -xzvf artifacts/build.tar.gz

    - name: Install packages
      run: sudo apt update && sudo apt install -y libyaml-dev valgrind libprotobuf-dev libpam-dev

    - name: Checkout Kong source code
      uses: actions/checkout@v3

    - name: Install Kong dev
      run: make dev LIBRARY_PREFIX=/usr/local/kong

    - name: Check test-helpers doc generation
      run: |
          source ${{ env.INSTALL_ROOT }}-venv.sh
          pushd ./spec && ldoc .

    - name: Check autodoc generation
      run: |
          source ${{ env.INSTALL_ROOT }}-venv.sh
          scripts/autodoc

    - name: Check Admin API definition generation
      run: |
          source ${{ env.INSTALL_ROOT }}-venv.sh
          scripts/gen-admin-api-def.sh

    - name: Static Code Analysis
      run: |
          make sca

    - name: Validate rockspec file
      run: |
          source ${{ env.INSTALL_ROOT }}-venv.sh
          scripts/validate-rockspec

    - name: Check spec file misspelling
      run: |
          scripts/check_spec_files_spelling.sh

    - name: Check labeler configuration
      run: scripts/check-labeler.pl .github/labeler.yml

    - name: Check EE bundled plugin list coverage
      run: |
          scripts/check_ee_bundled_plugin_list_coverage.sh

    - name: Unit tests
      env:
        KONG_TEST_PG_DATABASE: kong
        KONG_TEST_PG_USER: kong
      run: |
          source ${{ env.INSTALL_ROOT }}-venv.sh
          mkdir $TEST_RESULTS_XML_OUTPUT
          export XML_OUTPUT=$(realpath $TEST_RESULTS_XML_OUTPUT)
          watch -n 30 -t -w bash -c "free -m > /tmp/memusage.txt" 2>&1 >/dev/null &
          bin/busted -v -o hjtest -Xoutput $XML_OUTPUT/report.xml spec/01-unit spec-ee/01-unit
          cat /tmp/memusage.txt

    - uses: datadog/junit-upload-github-action@768dae7c808e17eed51ece17871e21f27fd5a000
      if: ${{ always() && env.HAS_ACCESS_TO_SECRETS == 'true' }} # upload test results even if the job fails
      with:
        api-key: ${{ secrets.DATADOG_API_KEY }}
        service: kong-ee-github-actions-ci
        files: ${{ env.TEST_RESULTS_XML_OUTPUT }}

  integration-tests-postgres:
    name: Postgres ${{ matrix.suite }} - ${{ matrix.split }} tests
    runs-on: [self-hosted, Hetzner]
    timeout-minutes: 30
    needs: build

    strategy:
      fail-fast: false
      matrix:
        suite: [integration, plugins]
        split: [first-CE, second-CE, first-EE, second-EE, third-EE]
        exclude:
          - suite: plugins
            split: second-EE
          - suite: plugins
            split: third-EE

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: kong
          POSTGRES_DB: kong
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 5s --health-timeout 5s --health-retries 8

      grpcbin:
        image: kong/grpcbin
        ports:
          - 15002:9000
          - 15003:9001

      redis:
        image: redis
        ports:
          - 6379:6379
          - 6380:6380
        options: >-
          --name kong_redis

      zipkin:
        image: openzipkin/zipkin:2.19
        ports:
          - 9411:9411

    steps:
    - name: Set environment variables
      run: |
          echo "INSTALL_ROOT=$(pwd)/bazel-bin/build/kong-dev" >> $GITHUB_ENV

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: build
        path: .

    - name: Extract the artifact contents
      run: sudo tar -C /usr/local/ -xzvf artifacts/build.tar.gz

    - name: Install packages
      run: sudo apt update && sudo apt install -y libyaml-dev valgrind libprotobuf-dev libpam-dev

    - name: Checkout Kong source code
      uses: actions/checkout@v3

    - name: Install Kong dev
      run: make dev LIBRARY_PREFIX=/usr/local/kong

    - name: Add gRPC test host names
      run: |
          echo "127.0.0.1 grpcs_1.test" | sudo tee -a /etc/hosts
          echo "127.0.0.1 grpcs_2.test" | sudo tee -a /etc/hosts

    - name: Enable SSL for Redis
      if: ${{ matrix.suite == 'plugins' }}
      run: |
          docker cp ${{ github.workspace }} kong_redis:/workspace
          docker cp ${{ github.workspace }}/spec/fixtures/redis/docker-entrypoint.sh kong_redis:/usr/local/bin/docker-entrypoint.sh
          docker restart kong_redis
          docker logs kong_redis

    - name: Run OpenTelemetry Collector
      if: ${{ matrix.suite == 'plugins' }}
      run: |
          mkdir -p ${{ github.workspace }}/tmp/otel
          touch ${{ github.workspace }}/tmp/otel/file_exporter.json
          sudo chmod 777 -R ${{ github.workspace }}/tmp/otel
          docker run -p 4317:4317 -p 4318:4318 -p 55679:55679 \
              -v ${{ github.workspace }}/spec/fixtures/opentelemetry/otelcol.yaml:/etc/otel-collector-config.yaml \
              -v ${{ github.workspace }}/tmp/otel:/etc/otel \
              --name opentelemetry-collector -d \
              otel/opentelemetry-collector-contrib:0.52.0 \
              --config=/etc/otel-collector-config.yaml
          sleep 2
          docker logs opentelemetry-collector

    - name: Tests
      env:
        PULP_PASSWORD: ${{ secrets.PULP_PASSWORD }}
        KONG_TEST_PG_DATABASE: kong
        KONG_TEST_PG_USER: kong
        KONG_TEST_DATABASE: postgres
        KONG_SPEC_TEST_GRPCBIN_PORT: "15002"
        KONG_SPEC_TEST_GRPCBIN_SSL_PORT: "15003"
        KONG_SPEC_TEST_OTELCOL_FILE_EXPORTER_PATH: ${{ github.workspace }}/tmp/otel/file_exporter.json
        TEST_SUITE: ${{ matrix.suite }}
        TEST_SPLIT: ${{ matrix.split }}
      run: |
          source ${{ env.INSTALL_ROOT }}-venv.sh
          mkdir $TEST_RESULTS_XML_OUTPUT
          export XML_OUTPUT=$(realpath $TEST_RESULTS_XML_OUTPUT)
          .ci/run_tests_github.sh

    - uses: datadog/junit-upload-github-action@768dae7c808e17eed51ece17871e21f27fd5a000
      if: ${{ always() && env.HAS_ACCESS_TO_SECRETS == 'true' }} # upload test results even if the job fails
      with:
        api-key: ${{ secrets.DATADOG_API_KEY }}
        service: kong-ee-github-actions-ci
        files: ${{ env.TEST_RESULTS_XML_OUTPUT }}

  integration-tests-dbless:
    name: DB-less integration tests
    runs-on: [self-hosted, Hetzner]
    timeout-minutes: 25
    needs: build

    services:
      grpcbin:
        image: moul/grpcbin
        ports:
          - 15002:9000
          - 15003:9001

    steps:
    - name: Set environment variables
      run: |
          echo "INSTALL_ROOT=$(pwd)/bazel-bin/build/kong-dev" >> $GITHUB_ENV

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: build
        path: .

    - name: Extract the artifact contents
      run: sudo tar -C /usr/local/ -xzvf artifacts/build.tar.gz

    - name: Install packages
      run: sudo apt update && sudo apt install -y libyaml-dev valgrind libprotobuf-dev libpam-dev

    - name: Checkout Kong source code
      uses: actions/checkout@v3

    - name: Install Kong dev
      run: make dev LIBRARY_PREFIX=/usr/local/kong

    - name: Add gRPC test host names
      run: |
          echo "127.0.0.1 grpcs_1.test" | sudo tee -a /etc/hosts
          echo "127.0.0.1 grpcs_2.test" | sudo tee -a /etc/hosts

    - name: Run OpenTelemetry Collector
      run: |
          mkdir -p ${{ github.workspace }}/tmp/otel
          touch ${{ github.workspace }}/tmp/otel/file_exporter.json
          sudo chmod 777 -R ${{ github.workspace }}/tmp/otel
          docker run -p 4317:4317 -p 4318:4318 -p 55679:55679 \
              -v ${{ github.workspace }}/spec/fixtures/opentelemetry/otelcol.yaml:/etc/otel-collector-config.yaml \
              -v ${{ github.workspace }}/tmp/otel:/etc/otel \
              --name opentelemetry-collector -d \
              otel/opentelemetry-collector-contrib:0.52.0 \
              --config=/etc/otel-collector-config.yaml
          sleep 2
          docker logs opentelemetry-collector

    - name: Tests
      env:
        PULP_PASSWORD: ${{ secrets.PULP_PASSWORD }}
        KONG_TEST_PG_DATABASE: kong
        KONG_TEST_PG_USER: kong
        KONG_TEST_DATABASE: 'off'
        KONG_SPEC_TEST_GRPCBIN_PORT: "15002"
        KONG_SPEC_TEST_GRPCBIN_SSL_PORT: "15003"
        KONG_SPEC_TEST_OTELCOL_FILE_EXPORTER_PATH: ${{ github.workspace }}/tmp/otel/file_exporter.json
        TEST_SUITE: dbless
      run: |
          source ${{ env.INSTALL_ROOT }}-venv.sh
          mkdir $TEST_RESULTS_XML_OUTPUT
          export XML_OUTPUT=$(realpath $TEST_RESULTS_XML_OUTPUT)
          .ci/run_tests_github.sh

    - uses: datadog/junit-upload-github-action@768dae7c808e17eed51ece17871e21f27fd5a000
      if: ${{ always() && env.HAS_ACCESS_TO_SECRETS == 'true' }} # upload test results even if the job fails
      with:
        api-key: ${{ secrets.DATADOG_API_KEY }}
        service: kong-ee-github-actions-ci
        files: ${{ env.TEST_RESULTS_XML_OUTPUT }}

  integration-tests-cassandra:
    name: C* ${{ matrix.cassandra_version }} ${{ matrix.suite }} - ${{ matrix.split }} tests
    runs-on: [self-hosted, Hetzner]
    timeout-minutes: 30
    needs: build

    strategy:
      fail-fast: false
      matrix:
        suite: [integration, plugins]
        cassandra_version: [3]
        split: [first-CE, second-CE, first-EE, second-EE, third-EE]
        exclude:
          - suite: plugins
            split: second-EE
          - suite: plugins
            split: third-EE

    services:
      cassandra:
        image: cassandra:${{ matrix.cassandra_version }}
        ports:
          - 7199:7199
          - 7000:7000
          - 9160:9160
          - 9042:9042
        options: --health-cmd "cqlsh -e 'describe cluster'" --health-interval 5s --health-timeout 5s --health-retries 8

      grpcbin:
        image: moul/grpcbin
        ports:
          - 15002:9000
          - 15003:9001

      redis:
        image: redis
        ports:
          - 6379:6379
          - 6380:6380
        options: >-
          --name kong_redis

      zipkin:
        image: openzipkin/zipkin:2.19
        ports:
          - 9411:9411

    steps:
    - name: Set environment variables
      run: |
          echo "INSTALL_ROOT=$(pwd)/bazel-bin/build/kong-dev" >> $GITHUB_ENV

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: build
        path: .

    - name: Extract the artifact contents
      run: sudo tar -C /usr/local/ -xzvf artifacts/build.tar.gz

    - name: Install packages
      run: sudo apt update && sudo apt install -y libyaml-dev valgrind libprotobuf-dev libpam-dev

    - name: Checkout Kong source code
      uses: actions/checkout@v3

    - name: Install Kong dev
      run: make dev LIBRARY_PREFIX=/usr/local/kong

    - name: Add gRPC test host names
      run: |
          echo "127.0.0.1 grpcs_1.test" | sudo tee -a /etc/hosts
          echo "127.0.0.1 grpcs_2.test" | sudo tee -a /etc/hosts

    - name: Enable SSL for Redis
      if: ${{ matrix.suite == 'plugins' }}
      run: |
          docker cp ${{ github.workspace }} kong_redis:/workspace
          docker cp ${{ github.workspace }}/spec/fixtures/redis/docker-entrypoint.sh kong_redis:/usr/local/bin/docker-entrypoint.sh
          docker restart kong_redis
          docker logs kong_redis

    - name: Run OpenTelemetry Collector
      if: ${{ matrix.suite == 'plugins' }}
      run: |
          mkdir -p ${{ github.workspace }}/tmp/otel
          touch ${{ github.workspace }}/tmp/otel/file_exporter.json
          sudo chmod 777 -R ${{ github.workspace }}/tmp/otel
          docker run -p 4317:4317 -p 4318:4318 -p 55679:55679 \
              -v ${{ github.workspace }}/spec/fixtures/opentelemetry/otelcol.yaml:/etc/otel-collector-config.yaml \
              -v ${{ github.workspace }}/tmp/otel:/etc/otel \
              --name opentelemetry-collector -d \
              otel/opentelemetry-collector-contrib:0.52.0 \
              --config=/etc/otel-collector-config.yaml
          sleep 2
          docker logs opentelemetry-collector

    - name: Tests
      env:
        PULP_PASSWORD: ${{ secrets.PULP_PASSWORD }}
        KONG_TEST_DATABASE: cassandra
        KONG_SPEC_TEST_GRPCBIN_PORT: "15002"
        KONG_SPEC_TEST_GRPCBIN_SSL_PORT: "15003"
        KONG_SPEC_TEST_OTELCOL_FILE_EXPORTER_PATH: ${{ github.workspace }}/tmp/otel/file_exporter.json
        TEST_SUITE: ${{ matrix.suite }}
        TEST_SPLIT: ${{ matrix.split }}
      run: |
          source ${{ env.INSTALL_ROOT }}-venv.sh
          mkdir $TEST_RESULTS_XML_OUTPUT
          export XML_OUTPUT=$(realpath $TEST_RESULTS_XML_OUTPUT)
          .ci/run_tests_github.sh

    - uses: datadog/junit-upload-github-action@768dae7c808e17eed51ece17871e21f27fd5a000
      if: ${{ always() && env.HAS_ACCESS_TO_SECRETS == 'true' }} # upload test results even if the job fails
      with:
        api-key: ${{ secrets.DATADOG_API_KEY }}
        service: kong-ee-github-actions-ci
        files: ${{ env.TEST_RESULTS_XML_OUTPUT }}

  pdk-tests:
    name: PDK tests
    runs-on: [self-hosted, Hetzner]
    timeout-minutes: 10
    needs: build

    steps:
    - name: Set environment variables
      run: |
          echo "INSTALL_ROOT=$(pwd)/bazel-bin/build/kong-dev" >> $GITHUB_ENV

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: build
        path: .

    - name: Extract the artifact contents
      run: sudo tar -C /usr/local/ -xzvf artifacts/build.tar.gz

    - name: Install packages
      run: sudo apt update && sudo apt install -y libyaml-dev valgrind libprotobuf-dev libpam-dev

    - name: Checkout Kong source code
      uses: actions/checkout@v3

    - name: Install Kong dev
      run: make dev LIBRARY_PREFIX=/usr/local/kong

    - name: Install Test::Nginx
      run: |
          CPAN_DOWNLOAD=$HOME/cpanm
          mkdir -p $CPAN_DOWNLOAD
          curl -o $CPAN_DOWNLOAD/cpanm https://cpanmin.us
          chmod +x $CPAN_DOWNLOAD/cpanm

          echo "Installing CPAN dependencies..."
          sudo apt install cpanminus -y
          $CPAN_DOWNLOAD/cpanm --notest --local-lib=$HOME/perl5 local::lib && eval $(perl -I $HOME/perl5/lib/perl5/ -Mlocal::lib)
          $CPAN_DOWNLOAD/cpanm --notest Test::Nginx

    - name: Tests
      env:
        PULP_PASSWORD: ${{ secrets.PULP_PASSWORD }}
        TEST_SUITE: pdk
      run: |
          source ${{ env.INSTALL_ROOT }}-venv.sh
          eval $(perl -I $HOME/perl5/lib/perl5/ -Mlocal::lib)
          TEST_NGINX_RANDOMIZE=1 prove -I. -r t/01-pdk/

  build-image:
    name: Build Pongo Base Image
    needs: build
    runs-on: [self-hosted, Hetzner]

    steps:
    - uses: actions/checkout@v3

    - name: Download artifact
      uses: actions/download-artifact@v3
      with:
        name: build
        path: .

    - name: Commit SHA
      id: commit-sha
      run: |
        # requires a valid commit SHA on tree; github.sha on pull_request is not usable
        if [[ ! -z "${{ github.event.pull_request.head.sha }}" ]]; then
          echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
        else
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
        fi

    - name: Build Docker Image
      uses: docker/build-push-action@v3
      # This can't be cached, pongo relies on org.opencontainers.image.revision label
      # which should be set to current commit's SHA. pongo uses this label to clone
      # kong-ee repo, checkout it and copy into the dev image.
      # If it there's a way to modify the label after image is built, or pongo has
      # a way to override it, then we can cache it. But this usually takes 30s, so
      # we should be fine-ish.
      with:
        file: build/dockerfiles/deb.Dockerfile
        context: .
        push: false
        tags: "pongo-local/kong-ee:latest"
        labels: org.opencontainers.image.revision=${{ steps.commit-sha.outputs.sha }}
        build-args: |
          KONG_BASE_IMAGE=ubuntu:22.04
          KONG_ARTIFACT_PATH=artifacts/
          EE_PORTS=8002 8445 8003 8446 8004 8447

    - name: Export Docker Image
      run: |
        mkdir docker-image
        docker image save -o docker-image/image.tar pongo-local/kong-ee:latest

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: docker-image/**

  plugins-ee-tests:
    name: plugins EE - ${{ matrix.split }} tests
    runs-on: [self-hosted, Hetzner]
    timeout-minutes: 30
    needs: build-image

    strategy:
      fail-fast: false
      matrix:
        split:
        - first
        - second
        - third
        - fourth
        - fifth
        - sixth
        - seventh
        - eighth
        - ninth

    env:
      PONGO_EXTRA_ARG: -o hjtest -Xoutput=/kong-plugin/report.html
      # XXX: in scripts/enterprise_plugin.sh, KONG_IMAGE (where pongo consumes)
      # is hardcoded to use $DOCKER_IMAGE_NAME
      # The image name is a local only image that's built on CI, it doesn't belong to
      # any public docker registry. It doesn't really mean the image is "latest".
      DOCKER_IMAGE_NAME: pongo-local/kong-ee:latest
      # this is also required
      KONG_VERSION: dev-ee

    steps:
    - name: Set the path
      run: |
        echo "/usr/local/openresty/bin/" >> $GITHUB_PATH
        echo "/usr/local/openresty/nginx/sbin/" >> $GITHUB_PATH
        echo "~/.local/bin" >> $GITHUB_PATH

    - name: Checkout Kong source code
      uses: actions/checkout@v3

    - name: Checkout kong-pongo
      uses: actions/checkout@v3
      with:
        repository: Kong/kong-pongo
        path: kong-pongo
        ref: 2.6.0
        submodules: recursive
        token: ${{ secrets.GHA_KONG_BOT_READ_TOKEN }}

    - name: Install pongo
      run: |
        mkdir -p ~/.local/bin
        ln -s $(realpath kong-pongo/pongo.sh) ~/.local/bin/pongo

    - name: Download docker image
      uses: actions/download-artifact@v3
      with:
        name: docker-image
        path: docker-images

    - name: Import docker image
      run: |
        docker load --input docker-images/image.tar

    - name: Tests
      env:
        PULP_PASSWORD: ${{ secrets.PULP_PASSWORD }}
        DOCKER_USERNAME: ${{ secrets.GHA_DOCKERHUB_PULL_USER }}
        DOCKER_PASSWORD: ${{ secrets.GHA_KONG_ORG_DOCKERHUB_PULL_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GHA_KONG_BOT_READ_TOKEN }}
        TEST_SUITE: plugins-ee
        TEST_SPLIT: ${{ matrix.split }}
      run: |
          mkdir $TEST_RESULTS_XML_OUTPUT
          export XML_OUTPUT=$(realpath $TEST_RESULTS_XML_OUTPUT)
          .ci/run_tests_github.sh

    - uses: datadog/junit-upload-github-action@768dae7c808e17eed51ece17871e21f27fd5a000
      if: ${{ always() && env.HAS_ACCESS_TO_SECRETS == 'true' }} # upload test results even if the job fails
      with:
        api-key: ${{ secrets.DATADOG_API_KEY }}
        service: kong-ee-github-actions-ci
        files: ${{ env.TEST_RESULTS_XML_OUTPUT }}

    - name: Get kernel message
      if: failure()
      run: |
        sudo dmesg -T

