// https://stackoverflow.com/questions/43214730/how-to-set-github-commit-status-with-jenkinsfile-not-using-a-pull-request-builde
void setBuildStatus(String message, String state) {
  step([
      $class: "GitHubCommitStatusSetter",
      reposSource: [$class: "ManuallyEnteredRepositorySource", url: "https://github.com/kong/kong-ee"],
      contextSource: [$class: "ManuallyEnteredCommitContextSource", context: "Kong EE Migration Paths"],
      errorHandlers: [[$class: "ChangingBuildStatusErrorHandler", result: "UNSTABLE"]],
      statusResultSource: [ $class: "ConditionalStatusResultSource", results: [[$class: "AnyBuildResult", message: message, state: state]] ]
  ]);
}

pipeline {

  agent {
    node {
      label 'hybrid'
    }
  }

  options {
    timeout(time: 100, unit: 'MINUTES')
  }

  environment {
    GITHUB_TOKEN = credentials('github_bot_access_token')
    // This will map DOCKERHUB_KONGCLOUD_PULL_USR and DOCKERHUB_KONGCLOUD_PULL_PSW
    DOCKERHUB_KONGCLOUD_PULL = credentials('DOCKERHUB_KONGCLOUD_PULL')
    SEALY_ALWAYS_TEARDOWN = 1
    PATH = "${env.PATH}:~/.local/bin"
    // Speed up build
    ENABLE_OPENTRACING = 0
    DOCKER_IMAGE_NAME="migration-tests"
    KONG_LICENSE_DATA = credentials('KONG_LICENSE_DATA')
  }

  stages {
    stage('prepare environment') {
      steps {
        sh """
          echo "${env.DOCKERHUB_KONGCLOUD_PULL_PSW}" | docker login -u "${env.DOCKERHUB_KONGCLOUD_PULL_USR}" --password-stdin

          [[ -d ~/.local/bin ]] || mkdir -p ~/.local/bin
          [[ -d ~/tools ]] || mkdir -p ~/tools

          # install or update gojira enterprise
          if [[ -f ~/tools/gojira-enterprise/gojira.sh ]]; then
            (
              cd ~/tools/gojira-enterprise
              git pull
            )
          else
            git clone https://${env.GITHUB_TOKEN}@github.com/Kong/gojira-enterprise ~/tools/gojira-enterprise
            ln -s \$(realpath ~/tools/gojira-enterprise/gojira.sh) ~/.local/bin/gojira
          fi

          # install or update sealy
          if [[ -f ~/tools/sealy/sealy.sh ]]; then
            (
              cd ~/tools/sealy
              git pull
            )
          else
            git clone https://${env.GITHUB_TOKEN}@github.com/Kong/sealy ~/tools/sealy
            ln -s \$(realpath ~/tools/sealy/sealy.sh) ~/.local/bin/sealy
          fi
        """
      }
    }

    stage('build dist image') {
      steps {
        sh "./dist/dist.sh build alpine"
        sh "./dist/dist.sh test alpine"
        sh "./dist/dist.sh build-image alpine"
      }
    }

    stage('2.1 to here') {
      steps {
        parallel (
          "Kong EE 2.1 to here (pg)": {
            sh "sealy --from kong/kong-gateway:2.1 --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path"
          },
          "Kong EE 2.1 to here (c*)": {
            sh "sealy --from kong/kong-gateway:2.1 --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path --cassandra"
          }
        )
      }
    }

    stage('next/2.2.x.x to here') {
      steps {
        parallel (
          "Kong EE next/2.2.x.x to here (pg)": {
            sh "sealy --from kong/kong-gateway-internal:2.2-nightly --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path"
          },
          "Kong EE next/2.2.x.x to here (c*)": {
            sh "sealy --from kong/kong-gateway-internal:2.2-nightly --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path --cassandra"
          }
        )
      }
    }

    stage('Kong EE < 1.5 to here') {
      steps {
        parallel (
          "Kong EE < 1.5 to here should err on upgrade! (pg)": {
            sh "! sealy --from kong/kong-gateway-private:1.3.0.3-alpine --to ${env.DOCKER_IMAGE_NAME} --seeds paths/empty"
          },
          "Kong EE < 1.5 to here should err on upgrade! (c*)": {
            sh "! sealy --from kong/kong-gateway-private:1.3.0.3-alpine --to ${env.DOCKER_IMAGE_NAME} --seeds paths/empty --cassandra"
          }
        )
      }
    }

    stage('Kong CE 2.3 to here') {
      steps {
        parallel (
          "Kong CE 2.3 to here (pg)": {
            sh "sealy --from kong:2.3-alpine --to ${env.DOCKER_IMAGE_NAME} --seeds paths/core_1.x_ee_1.x_happy_path"
          },
          "Kong CE 2.3 to here (c*)": {
            sh "sealy --from kong:2.3-alpine --to ${env.DOCKER_IMAGE_NAME} --seeds paths/core_1.x_ee_1.x_happy_path --cassandra"
          }
        )
      }
    }

    stage('next/2.4.x.x to here') {
      steps {
        parallel (
          "Kong EE next/2.4.x.x to here (pg)": {
            sh "sealy --from kong/kong-gateway-internal:2.4-nightly --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path"
          },
          "Kong EE next/2.4.x.x to here (c*)": {
            sh "sealy --from kong/kong-gateway-internal:2.4-nightly --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path --cassandra"
          }
        )
      }
    }

    stage('next/2.5.x.x to here') {
      steps {
        parallel (
          "Kong EE next/2.5.x.x to here (pg)": {
            sh "sealy --from kong/kong-gateway-internal:2.5-nightly --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path"
          },
          "Kong EE next/2.5.x.x to here (c*)": {
            sh "sealy --from kong/kong-gateway-internal:2.5-nightly --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path --cassandra"
          }
        )
      }
    }

    stage('next/2.6.x.x to here') {
      steps {
        parallel (
          "Kong EE next/2.6.x.x to here (pg)": {
            sh "sealy --from kong/kong-gateway-internal:2.6-nightly --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path"
          },
          "Kong EE next/2.6.x.x to here (c*)": {
            sh "sealy --from kong/kong-gateway-internal:2.6-nightly --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path --cassandra"
          }
        )
      }
    }
  }

  post {
    success {
      setBuildStatus("Build succeeded", "SUCCESS");
    }
    failure {
      setBuildStatus("Build failed", "FAILURE");
    }
  }
}
