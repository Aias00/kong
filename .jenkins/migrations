pipeline {

  agent {
    node {
      label 'bionic'
    }
  }

  options {
    timeout(time: 100, unit: 'MINUTES')
  }

  environment {
    GITHUB = credentials('GITHUB_TOKEN')
    GITHUB_TOKEN = credentials('GITHUB_TOKEN')
    DOCKER_REGISTRY_URL = "registry.kongcloud.io"
    // This will map DOCKER_REGISTRY_USR and DOCKER_REGISTRY_PSW
    DOCKER_REGISTRY = credentials('DOCKER_REGISTRY')
    // This will map BINTRAY_USR and BINTRAY_PSW
    BINTRAY = credentials('bintray')
    KONG_LICENSE_DATA = credentials('KONG_LICENSE_DATA')
    SEALY_ALWAYS_TEARDOWN = 1
    PATH = "${env.PATH}:~/.local/bin"
    // Speed up build
    ENABLE_OPENTRACING = 0
    DOCKER_IMAGE_NAME="migration-tests"
  }

  stages {
    stage('prepare environment') {
      steps {
        sh "docker login -u ${env.BINTRAY_USR} -p ${env.BINTRAY_PSW} kong-docker-kong-enterprise-edition-docker.bintray.io"
        sh "docker login -u ${env.DOCKER_REGISTRY_USR} -p ${env.DOCKER_REGISTRY_PSW} registry.kongcloud.io"
        sh "mkdir -p ~/.local/bin"

        sh "git clone https://$GITHUB_TOKEN:@github.com/Kong/kong-gojira.git /tmp/gojira"
        sh 'ln -s $(realpath /tmp/gojira/gojira.sh) $(realpath ~/.local/bin/gojira)'

        sh "git clone https://$GITHUB_TOKEN:@github.com/Kong/sealy.git /tmp/sealy"
        sh 'ln -s $(realpath /tmp/sealy/sealy.sh) $(realpath ~/.local/bin/sealy)'
      }
    }

    stage('build dist image') {
      steps {
        sh "./dist/dist.sh build alpine"
        sh "./dist/dist.sh test alpine"
        sh "./dist/dist.sh build-image alpine"
      }
    }

    stage('run migration integration tests') {
      steps {
        parallel (
          "Kong EE 1.5.0.4 to here (pg)": {
            sh "sealy --from kong-docker-kong-enterprise-edition-docker.bintray.io/kong-enterprise-edition:1.5.0.4-alpine --to ${env.DOCKER_IMAGE_NAME} --seeds paths/1.5.x_to_2.1.x_happy_path"
          },
          "Kong EE 1.5.0.4 to here (c*)": {
            sh "sealy --from kong-docker-kong-enterprise-edition-docker.bintray.io/kong-enterprise-edition:1.5.0.4-alpine --to ${env.DOCKER_IMAGE_NAME} --seeds paths/1.5.x_to_2.1.x_happy_path --cassandra"
          },
          "Kong EE next/2.1.x.x to here (pg)": {
            sh "sealy --from registry.kongcloud.io/kong-enterprise-edition:next-2.1.x.x-nightly-alpine --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path"
          },
          "Kong EE next/2.1.x.x to here (c*)": {
            sh "sealy --from registry.kongcloud.io/kong-enterprise-edition:next-2.1.x.x-nightly-alpine --to ${env.DOCKER_IMAGE_NAME} --seeds paths/2.1.x_happy_path --cassandra"
          }
        )
      }
    }
  }
}
