pipeline {
  agent {
    node {
      label 'docker-compose'
    }
  }
  options {
    timeout(time: 150, unit: 'MINUTES')
  }
  environment {
    BINTRAY = credentials('bintray')
    GITHUB = credentials('GITHUB_TOKEN')
  }
  stages {
    stage('prepare') {

      steps {
        sh 'rm -fr /tmp/gojira'
        sh 'git clone https://$GITHUB:@github.com/Kong/kong-gojira.git /tmp/gojira || true'
        sh 'ls -las /tmp'
      }
    }
    stage('all') {
      environment {
        TEST_SUITE='lint'
        GOJIRA='/tmp/gojira/gojira.sh'
      }
      steps {
        sh '$GOJIRA down -k .'
        sh '$GOJIRA up -k ./'
        sh 'sed -i "442,443 s/stdin_open: true/stdin_open: false/" /tmp/gojira/docker/docker-compose.yml.sh'
        sh 'sed -i "442,443 s/tty: true/tty: true/" /tmp/gojira/docker/docker-compose.yml.sh'
        sh 'sed -e "442,443 s/kong bash -l -i/-T kong bash -l/" $GOJIRA'
        sh 'sed -i "442,443 s/kong bash -l -i/-T kong bash -l/" $GOJIRA'
        sh '$GOJIRA run ls -k . -v'
        sh '$GOJIRA run make dev -k . -v'
        // sh '$GOJIRA compose exec -T -e TEST_SUITE=pdk kong bash -l .ci/run_tests.sh -k . -v'
        sh '$GOJIRA compose exec -T -e TEST_SUITE=plugins kong bash -l .ci/run_tests.sh -k . -v'
        sh '$GOJIRA compose exec -T -e TEST_SUITE=plugins-ee kong bash -l .ci/run_tests.sh -k . -v'
        sh '$GOJIRA compose exec -T -e TEST_SUITE=integration kong bash -l .ci/run_tests.sh -k . -v'
        sh '$GOJIRA compose exec -T -e TEST_SUITE=integration-ee kong bash -l .ci/run_tests.sh -k . -v'
        // sh '$GOJIRA run make test-integration -k . -v'
        // sh '$GOJIRA run make test-plugins -k . -v'
        // sh '$GOJIRA run make test-ee -k . -v'
        // sh '$GOJIRA run make test-integration-ee -k . -v'
        // sh '$GOJIRA run make test-plugins-ee -k . -v'
        sh '$GOJIRA down -k .'
      }
    }
  }
}